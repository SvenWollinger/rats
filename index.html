<html lang="en">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="css/reset.css">
        <link rel="stylesheet" href="css/style.css">
        <link rel="icon" href="img/favicon.webp" />
        <title>rats - wollinger.io</title>
    </head>
    <body>
        <div id="gallery" >
            <div id="galleryContainer">
                <div id="galleryLeft" class="pointer galleryNav">
                    <img src="/img/left.svg" alt="Gallery Left" draggable="false">
                </div>
                <div>
                    <div style="width:100%;">
                        <img draggable="false" style="height:5vh;" class="pointer" onclick="closeGallery()" src="/img/close.svg" alt="Close Gallery">
                    </div>
                    <img alt="Gallery Image" id="galleryImage" src="">
                    <div style="width:100%;display:flex; justify-content:center;">
                        <a id="galleryDownloadLink" href="" download><img style="height:5vh;" src="/img/download.svg" alt="Download Image"></a>
                    </div>
                </div>
                <div id="galleryRight" class="pointer galleryNav">
                    <img src="/img/right.svg" alt="Gallery Right" draggable="false">
                </div>
            </div>
        </div>
        <h1 style="text-align: center;">My Rattos</h1>
        <div id="content">
            <div id="selectedRatArea" style="width:100%;">

                <div class="card">
                    <p><a href="/" style="color:black;"><img src="/img/home.svg" style="width:5vh;position:absolute;" alt="home"></a></p>
                    <div class="cardInner">
                        <div style="float:left;width:40%;">
                            <h2 class="ratAboutInfoHeading" id="selectedRatName">Loading...</h2>
                            <br>
                            <h3 class="ratAboutInfoHeading">Born: <span id="selectedRatBorn">Loading...</span></h3>
                            <h3 class="ratAboutInfoHeading" id="selectedRatRBParent">Rainbow Bridge: <span id="selectedRatRB">Loading...</span></h3>
                            <br>
                            <h3 class="ratAboutInfoHeading">Gallery</h3>
                            <div id="selectedRatGallery">
                            </div>
                        </div>
                        <div style="float:left;width:40%;margin-left:5%;">
                            <img id="selectedRatBigPic" style="width:100% auto; max-height:50vh;" alt="Rat Big Pic" src="">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <script src="/js/ratloader.js"></script>
    <script>
        class Config {
            rats
        }

        document.getElementById("gallery").onclick = (e1, e2) => {
            if(e1.target.id === "gallery") closeGallery()
        }

        function openGallery(image) {
            setSearchParam("gallery", image)
            document.getElementById("gallery").style.display = "flex"
            document.getElementById("galleryImage").src = image
            document.getElementById("galleryDownloadLink").href = image
        }

        function closeGallery() {
            clearSearchParam("gallery")
            document.getElementById("gallery").style.display = "none"
        }

        function setSearchParam(key, value) {
            let params = new URLSearchParams(window.location.search)
            params.set(key, value)
            window.history.pushState("", "", "?" + params.toString())
        }

        function clearSearchParam(key) {
            let params = new URLSearchParams(window.location.search)
            params.delete(key)
            window.history.pushState("", "", "?" + params.toString())
        }

        function params() {
            return new URLSearchParams(window.location.search)
        }

        get("/json/config.json", (json) => {
            let config = Object.assign(new Config(), JSON.parse(json))
            console.log("Config loaded:")
            console.log(config)

            let selectedRat = params().get("rat")
            let content = document.getElementById("content")
            if(selectedRat == null) {
                content.innerHTML = `<h1 style="text-align:center;width:100%;">All Rattos:</h1>`
                config.rats.forEach((id) => {
                    loadRat(id, (rat) => {
                        let card = document.createElement("div")
                        card.className = "card"
                        let cardContent = document.createElement("div")
                        cardContent.className = "cardInner"
                        card.appendChild(cardContent)

                        let ratThumbnail = document.createElement("img")
                        ratThumbnail.src = rat.thumbnail
                        ratThumbnail.className = "ratThumbnail"
                        ratThumbnail.onclick = () => {
                            window.location = "/?rat=" + id
                        }
                        cardContent.appendChild(ratThumbnail)

                        let ratTitle = document.createElement("h1")
                        ratTitle.innerText = rat.name
                        if(rat.passed != null) ratTitle.innerText += " â€ "
                        ratTitle.style.textAlign = "center"
                        ratTitle.style.color = "black"
                        cardContent.appendChild(ratTitle)

                        content.appendChild(card)
                    })
                })
            } else {
                if(config.rats.includes(selectedRat)) {
                    loadRat(selectedRat, (rat) => {
                        if(params().get("gallery") != null) {
                            openGallery(params().get("gallery"))
                        }

                        document.getElementById("galleryRight").onclick = () => {
                            let nextIndex = rat.images.indexOf(params().get("gallery")) + 1;
                            if(nextIndex >= rat.images.length) nextIndex = 0

                            setSearchParam("gallery", rat.images[nextIndex])
                            openGallery(rat.images[nextIndex])
                        }

                        document.getElementById("galleryLeft").onclick = () => {
                            let nextIndex = rat.images.indexOf(params().get("gallery")) - 1;
                            if(nextIndex < 0) nextIndex = rat.images.length - 1

                            setSearchParam("gallery", rat.images[nextIndex])
                            openGallery(rat.images[nextIndex])
                        }

                        let gallery = document.getElementById("selectedRatGallery")
                        rat.images.forEach((image) => {
                            console.log(image)
                            let galleryThumb = document.createElement("img")
                            galleryThumb.src = image
                            galleryThumb.style.maxWidth = "15vw"
                            galleryThumb.style.maxHeight = "15vh"
                            galleryThumb.style.padding = "5px"
                            galleryThumb.style.borderRadius = "10px 10px 10px 10px"

                            galleryThumb.className = "pointer"
                            galleryThumb.onclick = () => {
                                openGallery(image)
                            }
                            gallery.appendChild(galleryThumb)
                        })
                        document.getElementById("selectedRatName").innerText = rat.name
                        document.getElementById("selectedRatArea").style.display = "flex"
                        document.getElementById("selectedRatBigPic").src = rat.bigPic
                        document.getElementById("selectedRatBorn").innerText = rat.born
                        if(rat.passed != null)
                            document.getElementById("selectedRatRB").innerText = rat.passed
                        else
                            document.getElementById("selectedRatRBParent").style.display = "none"
                    })
                } else {
                    document.getElementById("content").innerHTML =
                        "<div style='text-align:center'><p>Rat not found!</p>" +
                        "<a href='/'>Go back?</a></div>"
                }
            }
        })




    </script>
</html>